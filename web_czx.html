<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/themes/light/main.css" />
	<!-- <script type="text/javascript" src="http://www.17sucai.com/preview/776298/2017-12-17/sidebar/js/jquery-1.11.0.min.js"></script> -->
	<script src="https://js.arcgis.com/4.11/"></script>
	<style>
		* {
			padding: 0px;
			margin: 0px;
		}

		body {
			position: absolute;
			width: 100%;
			height: 100%;
			background-color: white;
			z-index: 0px;
		}

		/* 横向导航条 */
		.topnav {
			overflow: hidden;
			background-color: #333;
			position: relative;
			width: 100%;
			height: 8%;
			z-index: 1px;
		}

		/* 导航条链接 */
		.topnav h3 {
			float: left;
			display: block;
			color: #f2f2f2;
			text-align: center;
			padding: 14px 16px;
			text-decoration: none;
			border-right: 1px solid white;
		}

		/* 链接颜色修改 */
		.topnav h3:hover {
			background-color: #ddd;
			color: black;
		}
		/*地图容器*/
		#viewDiv {
			position: relative;
			width: 100%;
			height: 92%;
			background-color: white;
			z-index: 2px;
		}
		/*测量控件*/
		#topbar {
			background: #fff;
			padding: 10px;
			display: none;
			border-radius: 10px;
		}
		.action-button {
			font-size: 16px;
			background-color: transparent;
			border: 1px solid #d3d3d3;
			color: #6e6e6e;
			height: 32px;
			width: 32px;
			text-align: center;
			box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
		}
		.action-button:hover,
		.action-button:focus {
			background: #0079c1;
			color: #e4e4e4;
		}
		.active {
			background: #0079c1;
			color: #e4e4e4;
		}
		/*缓冲区控件*/
		#buffer{
			background: #fff;
			padding: 10px;
			display: none;
			border-radius: 10px;
		}
	</style>
	<body>
		<div class="topnav">
			<h3>中国5A级景区一览图</h3>
			<h3 onclick="search()">景点搜索</h3>
			<h3 onclick="buffer_c()">路网缓冲区</h3>
			<h3 onclick="heat()">景点热力图</h3>
			<h3 onclick="measurement_c()">测量功能</h3>
			<h3 onclick="mark_c()">增减注记</h3>
			<h3 id="point_h3">
			<input type="checkbox" id="point" checked="checked">景点图层
			</h3>
			<h3 id="line_h3">
			  <input type="checkbox" id="line" checked="checked">路网图层
			</h3>
			<h3 id="polygon_h3">
			  <input type="checkbox" id="polygon" checked="checked">市级图层
			</h3>
			<h3 onclick="basemap_c()" style="float: right;">底图切换窗口</h3>
		</div>
		<div id="viewDiv">
		</div>
		<div id="topbar">
			<button class="action-button esri-icon-minus" id="distanceButton" type="button" title="Measure distance between two or more points"></button>
			<button class="action-button esri-icon-polygon" id="areaButton" type="button" title="Measure area"></button>
		</div>
		<div id="buffer">缓冲区半径:
			<input id="distance" type="range" min="10" max="150000" step="10" value="10000" />&nbsp; <span id="distance-value">150000</span>
			meters <br />
		</div>
	</body>
	<script>
		var map, view, heatmap_renderer, searchWidget, csvLayer, pointRenderer, trailheadsLabels, basemapGallery;
		var control_search = true;
		var control_heat = true;
		var control_measurement = true;
		var control_bufferment = true;
		var control_mark = true;
		var control_basemap = true;
		var measurement = document.getElementById("topbar");
		var bufferment = document.getElementById("buffer");
		var activeWidget = null;
		//引用arcgis类
		require(["esri/Map",
			"esri/widgets/Legend",
			"esri/layers/GeoJSONLayer",
			"esri/layers/CSVLayer",
			"esri/views/MapView",
			"esri/widgets/Search",
			"esri/widgets/DistanceMeasurement2D",
			"esri/widgets/AreaMeasurement2D",
			"esri/geometry/geometryEngine",
			"esri/Graphic",
			"esri/widgets/BasemapGallery"
		], function(Map, Legend, GeoJSONLayer, CSVLayer, MapView, Search, DistanceMeasurement2D, AreaMeasurement2D,
			geometryEngine, Graphic, BasemapGallery) {
			//定义一个地图			
			map = new Map({
				basemap: "streets-night-vector"
			});
			//定义一个视图view2d，用来装地图map
			view = new MapView({
				container: "viewDiv", // Reference to the DOM node that will contain the view
				map: map, // References the map object created in step 3
				zoom: 4,
				center: [116, 39]
			});
			//定义一个底图的renderer渲染器
			var defaultSym = {
				type: "simple-fill", // autocasts as new SimpleFillSymbol()
				outline: {
					// autocasts as new SimpleLineSymbol()
					color: [128, 128, 128, 0.2],
					width: "0.5px"
				}
			};
			var Moth_renderer = {
				type: "simple", // autocasts as new SimpleRenderer()
				symbol: defaultSym,
				visualVariables: [{
					type: "color",
					field: "ID_1",
					stops: [{
							value: 589,
							color: "#FFFCD4",
							label: "<10%"
						},
						{
							value: 602,
							color: [153, 83, 41],
							label: ">30%"
						}
					]
				}]
			};
			//定义一个公路图层的renderer渲染器
			var Publicroad_renderer = {
				type: "simple", // autocasts as new SimpleRenderer()
				symbol: {
					type: "simple-line", // autocasts as new SimpleLineSymbol()
					width: 3,
					color: [255, 0, 0, 0.4]
				}
			};
			//定义一个景点的popupTemplate
			var template = {
				// autocasts as new PopupTemplate()
				title: "中国五A级风景名胜之{name}",
				content: [{
					// It is also possible to set the fieldInfos outside of the content
					// directly in the popupTemplate. If no fieldInfos is specifically set
					// in the content, it defaults to whatever may be set within the popupTemplate.
					type: "fields",
					fieldInfos: [{
							fieldName: "name",
							label: "景区名称",
							format: {
								digitSeparator: true,
								places: 0
							}
						},
						{
							fieldName: "wd",
							label: "纬度",
							format: {
								digitSeparator: true,
								places: 0
							}
						},
						{
							fieldName: "jd",
							label: "经度",
							format: {
								digitSeparator: true,
								places: 0
							}
						}
					]
				}]
			};
			pointRenderer = {
				type: "simple", // autocasts as new SimpleRenderer()
				symbol: {
					type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
					size: 6,
					color: [255, 0, 0],
					outline: null
				}
			};
			//定义一个热力图渲染器
			heatmap_renderer = {
				type: "heatmap",
				colorStops: [{
						color: "rgba(63, 40, 102, 0)",
						ratio: 0
					},
					{
						color: "#472b77",
						ratio: 0.083
					},
					{
						color: "#4e2d87",
						ratio: 0.166
					},
					{
						color: "#563098",
						ratio: 0.249
					},
					{
						color: "#5d32a8",
						ratio: 0.332
					},
					{
						color: "#6735be",
						ratio: 0.415
					},
					{
						color: "#7139d4",
						ratio: 0.498
					},
					{
						color: "#7b3ce9",
						ratio: 0.581
					},
					{
						color: "#853fff",
						ratio: 0.664
					},
					{
						color: "#a46fbf",
						ratio: 0.747
					},
					{
						color: "#c29f80",
						ratio: 0.83
					},
					{
						color: "#e0cf40",
						ratio: 0.913
					},
					{
						color: "#ffff00",
						ratio: 1
					}
				],
				maxPixelIntensity: 25,
				minPixelIntensity: 0
			};
			//注记
			trailheadsLabels = {
				symbol: {
					type: "text",
					color: "#FFFFFF",
					haloColor: "#5E8D74",
					haloSize: "2px",
					font: {
						size: "10px",
						family: "noto-sans",
						style: "italic",
						weight: "normal"
					}
				},
				labelPlacement: "above-center",
				labelExpressionInfo: {
					expression: "$feature.name"
				}
			};
			//定义一个geojsonlayer作为底图
			var Moth_geoJSONLayer = new GeoJSONLayer({
				url: "https://201622110813037.github.io/china/china.json",
				renderer: Moth_renderer
			});
			//定义一个geojsonlayer作为公路图层
			var Publicroad_geoJSONLayer = new GeoJSONLayer({
				url: "https://201622110813037.github.io/china/Publicroad.json",
				renderer: Publicroad_renderer
			});
			//定义一个csvLayer作为5A级景点的点图层
			var url = "https://201622110813037.github.io/china/point2.csv";
			csvLayer = new CSVLayer({
				url: url,
				latitudeField: "wd", //纬度
				longitudeField: "jd", //经度
				popupTemplate: template,
				renderer: pointRenderer,
				/* labelingInfo: [trailheadsLabels] */
			});
			//定义一个搜索控件
			searchWidget = new Search({
				view: view,
				allPlaceholder: "故宫博物院，选择查询图层",
				sources: [{
					layer: csvLayer,
					searchFields: ["name"],
					displayField: "name",
					/* exactMatch: false, */
					outFields: ["name", "wd", "jd"],
					name: "中国5A级景区图层",
					placeholder: "故宫博物院，选择查询图层"
				}]
			});
			//定义一个坐标显示控件
			var coordsWidget = document.createElement("div");
			coordsWidget.id = "coordsWidget";
			coordsWidget.className = "esri-widget esri-component";
			coordsWidget.style.padding = "7px 15px 5px";
			view.ui.add(coordsWidget, "bottom-left");
			//*** ADD ***//
			function showCoordinates(pt) {
				var coords = "Lat/Lon " + pt.latitude.toFixed(3) + " " + pt.longitude.toFixed(3) +
					" | Scale 1:" + Math.round(view.scale * 1) / 1 +
					" | Zoom " + view.zoom;
				coordsWidget.innerHTML = coords;
			}
			//添加事件和监视处理程序
			view.watch("stationary", function(isStationary) {
				showCoordinates(view.center);
			});
			view.on("pointer-move", function(evt) {
				showCoordinates(view.toMap({
					x: evt.x,
					y: evt.y
				}));
			});
			//定义测量控件
			view.ui.add("topbar", "top-right");
			document
				.getElementById("distanceButton")
				.addEventListener("click", function() {
					setActiveWidget(null);
					if (!this.classList.contains("active")) {
						setActiveWidget("distance");
					} else {
						setActiveButton(null);
					}
				});
			document
				.getElementById("areaButton")
				.addEventListener("click", function() {
					setActiveWidget(null);
					if (!this.classList.contains("active")) {
						setActiveWidget("area");
					} else {
						setActiveButton(null);
					}
				});

			function setActiveWidget(type) {
				switch (type) {
					case "distance":
						activeWidget = new DistanceMeasurement2D({
							view: view
						});
						// skip the initial 'new measurement' button
						activeWidget.viewModel.newMeasurement();
						view.ui.add(activeWidget, "top-right");
						setActiveButton(document.getElementById("distanceButton"));
						break;
					case "area":
						activeWidget = new AreaMeasurement2D({
							view: view
						});
						// skip the initial 'new measurement' button
						activeWidget.viewModel.newMeasurement();
						view.ui.add(activeWidget, "top-right");
						setActiveButton(document.getElementById("areaButton"));
						break;
					case null:
						if (activeWidget) {
							view.ui.remove(activeWidget);
							activeWidget.destroy();
							activeWidget = null;
						}
						break;
				}
			}
			//缓冲区
			view.ui.add("buffer", "top-right");
			view
				.when(function() {
					return Publicroad_geoJSONLayer.when(function() {
						var query = Publicroad_geoJSONLayer.createQuery();
						return Publicroad_geoJSONLayer.queryFeatures(query);
					});
				})
				.then(queryForWellGeometries)
				.then(createBuffer);
			var distanceSlider = document.getElementById("distance");
			var wellBuffer, wellsGeometries;

			function queryForWellGeometries() {
				var wellsQuery = Publicroad_geoJSONLayer.createQuery();
				return Publicroad_geoJSONLayer.queryFeatures(wellsQuery).then(function(response) {
					wellsGeometries = response.features.map(function(feature) {
						return feature.geometry;
					});
					return wellsGeometries;
				});
			}

			function createBuffer(welllines) {
				var bufferDistance = parseInt(distanceSlider.value);
				var wellBuffers = geometryEngine.geodesicBuffer(
					welllines, [bufferDistance],
					"meters",
					true
				);
				wellBuffer = wellBuffers[0];
				// add the buffer to the view as a graphic
				var bufferGraphic = new Graphic({
					geometry: wellBuffer,
					symbol: {
						type: "simple-fill", // autocasts as new SimpleFillSymbol()
						outline: {
							width: 1,
							color: "#8B0000"
						},
						style: "none"
					}
				});
				view.graphics.removeAll();
				view.graphics.add(bufferGraphic);
			}
			//监听缓冲区距离
			distanceSlider.addEventListener("input", function() {
				document.getElementById("distance-value").innerText = distanceSlider.value;
			});
			//监听缓冲区改变事件
			distanceSlider.addEventListener("change", function() {
				createBuffer(wellsGeometries);
			});
			//定义一个地图切换部件
			basemapGallery = new BasemapGallery({
				view: view,
				source: {
					portal: {
						url: "https://www.arcgis.com",
						useVectorBasemaps: true // Load vector tile basemaps
					}
				}
			});
			//加载图层
			map.add(Moth_geoJSONLayer);
			map.add(Publicroad_geoJSONLayer);
			map.add(csvLayer);
			//高亮
			view.whenLayerView(Moth_geoJSONLayer).then(function(layerView) {
				layerView.watch("updating", function(value) {
					if (!value) {
						var highlightHUBU;
						view.on('pointer-move', function(evt) {
							var point = view.toMap({
								x: evt.x,
								y: evt.y
							});
							// query all the features available for drawing.
							layerView
								.queryFeatures({
									geometry: point,
									returnGeometry: true
								})
								.then(function(results) {
									if (highlightHUBU) {
										highlightHUBU.remove();
									}
									highlightHUBU = layerView.highlight(results.features);

								})
								.catch(function(error) {
									console.error("query failed: ", error);
								});
						});


					}
				});
			});
			//图层显示与隐藏控制
			var pointToggle = document.getElementById("point");
			var lineToggle = document.getElementById("line");
			var polygonToggle = document.getElementById("polygon");
			pointToggle.addEventListener("change", function () {
			  csvLayer.visible = pointToggle.checked;
			});
			lineToggle.addEventListener("change", function () {
			  Publicroad_geoJSONLayer.visible = lineToggle.checked;
			});
			polygonToggle.addEventListener("change", function () {
			  Moth_geoJSONLayer.visible = polygonToggle.checked;
			});
		});
		//自定义菜单栏控制函数
		function search() {
			if (control_search == true) {
				control_search = false;
				view.ui.add(searchWidget, {
					position: "top-right"
				});
			} else {
				control_search = true;
				view.ui.remove(searchWidget);
			}
		}
		function heat() {
			if (control_heat == true) {
				control_heat = false;
				csvLayer.renderer = heatmap_renderer;
			} else {
				control_heat = true;
				csvLayer.renderer = pointRenderer;
			}
		}
		function measurement_c() {
			if (control_measurement == true) {
				control_measurement = false;
				measurement.style.display = "block";
			} else {
				control_measurement = true;
				measurement.style.display = "none";
			}
		}
		function buffer_c() {
			if (control_bufferment == true) {
				control_bufferment = false;
				bufferment.style.display = "block";
			} else {
				control_bufferment = true;
				bufferment.style.display = "none";
				view.graphics.removeAll();
			}
		}
		function mark_c() {
			if (control_mark == true) {
				control_mark = false;
				csvLayer.labelingInfo = [trailheadsLabels];
			} else {
				control_mark = true;
				csvLayer.labelingInfo = [];
			}
		}
		function basemap_c() {
			if (control_basemap == true) {
				control_basemap = false;
				view.ui.add(basemapGallery, "bottom-right");
			} else {
				control_basemap = true;
				view.ui.remove(basemapGallery, "bottom-right");
			}
		}
	</script>
</html>
